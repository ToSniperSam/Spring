<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Transportation Demo</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .bold {
            font-weight: bold;
        }
        .info {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        .error {
            color: red;
        }
        .warning {
            color: orange;
        }

        /* Custom file input styles */
        .file-label {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }
        .file-label:hover {
            background-color: #45a049;
        }
        #fileInput {
            display: none;  /* Hide the original file input */
        }
        .file-name {
            margin-left: 10px;
            font-style: italic;
        }
    </style>
    <script>
        // Update file name display when a file is selected
        function updateFileName() {
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            fileName.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : "No file chosen";
        }

        // Sort data
        function sortData() {
            const column = document.getElementById("sortColumn").value;
            const order = document.querySelector('input[name="order"]:checked').value;

            if (column) {
                const form = document.createElement("form");
                form.method = "post";
                form.action = "/sort";

                const columnInput = document.createElement("input");
                columnInput.type = "hidden";
                columnInput.name = "column";
                columnInput.value = column;

                const orderInput = document.createElement("input");
                orderInput.type = "hidden";
                orderInput.name = "order";
                orderInput.value = order;

                form.appendChild(columnInput);
                form.appendChild(orderInput);
                document.body.appendChild(form);
                form.submit();
            } else {
                alert("Please choose the column!");
            }
        }

        // Search data
        function searchData() {
            const column = document.getElementById("searchColumn").value;
            const keyword = document.getElementById("searchKeyword").value;

            if (column && keyword) {
                const form = document.createElement("form");
                form.method = "post";
                form.action = "/search";

                const columnInput = document.createElement("input");
                columnInput.type = "hidden";
                columnInput.name = "column";
                columnInput.value = column;

                const keywordInput = document.createElement("input");
                keywordInput.type = "hidden";
                keywordInput.name = "keyword";
                keywordInput.value = keyword;

                form.appendChild(columnInput);
                form.appendChild(keywordInput);
                document.body.appendChild(form);
                form.submit();
            } else {
                alert("Please choose the column and keyword!");
            }
        }

        // Export data
        function exportData(type) {
            const url = `/export?type=${type}`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(error => {
                            throw new Error(error);
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    const downloadFileName = type === 'search' ? 'search_results.csv' : 'sorted_data.csv';

                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = downloadFileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => {
                    alert("Error!ï¼š" + error.message);
                });
        }

    </script>
</head>
<body>
<h1>Upload and Functions</h1>

<form action="/upload" method="post" enctype="multipart/form-data">
    <!-- Custom file input using a label -->
    <label for="fileInput" class="file-label">Choose File</label>
    <input type="file" id="fileInput" name="file" accept=".csv" required onchange="updateFileName()" />
    <span id="fileName" class="file-name">No file chosen</span>
    <button type="submit">Upload File</button>
</form>

<!-- Display warning, error, and info -->
<div class="info" th:if="${message}" th:text="${message}"></div>
<div class="error" th:if="${error}" th:text="${error}"></div>
<div class="warning" th:if="${warning}" th:text="${warning}"></div>

<hr/>

<!-- Function selection -->
<h2>Choose a Function</h2>
<div>
    <button onclick="document.getElementById('sortSection').style.display = 'block'; document.getElementById('searchSection').style.display = 'none';">Sort</button>
    <button onclick="document.getElementById('sortSection').style.display = 'none'; document.getElementById('searchSection').style.display = 'block';">Search</button>
</div>

<hr/>

<!-- Sorting form -->
<div id="sortSection" style="display:none;">
    <h2>Sort Configuration</h2>
    <form method="post" onsubmit="sortData(); return false;">
        <label for="sortColumn">Choose Sorting Column:</label>
        <select id="sortColumn" name="column">
            <option value="VehicleType">Vehicle Type</option>
            <option value="DirectionTime_O">Direction Time (Out)</option>
            <option value="GantryID_O">Gantry ID (Out)</option>
            <option value="TripLength">Trip Length</option>
        </select>

        <label>
            <input type="radio" name="order" value="asc" checked /> ASC
        </label>
        <label>
            <input type="radio" name="order" value="desc" /> DESC
        </label>

        <button type="submit">Sort!</button>
    </form>
</div>

<!-- Search form -->
<div id="searchSection" style="display:none;">
    <h2>Search Configuration</h2>
    <form method="post" onsubmit="searchData(); return false;">
        <label for="searchColumn">Choose Search Column:</label>
        <select id="searchColumn" name="column">
            <option value="VehicleType">Vehicle Type</option>
            <option value="DirectionTime_O">Direction Time (Out)</option>
            <option value="GantryID_O">Gantry ID (Out)</option>
            <option value="TripLength">Trip Length</option>
        </select>

        <label for="searchKeyword">Keyword:</label>
        <input type="text" id="searchKeyword" name="keyword" required />

        <button type="submit">Search!</button>
    </form>
</div>

<hr/>

<!-- Display sort time -->
<div th:if="${sortTime}">
    <p>Column: <span th:text="${currentColumn}"></span></p>
    <p th:text="'Sort Timing: ' + ${sortTime} + ' ms'"></p>
    <p th:text="'Order: ' + ${descending} "></p>
    <button id="exportButtonSort" onclick="exportData()">Export Sorting Results</button>
    <div id="exportError" style="color: red; display: none;"></div>
</div>

<!-- Display search time and result count -->
<div th:if="${searchTime}">
    <p>Keyword: <span th:text="${searchKeyword}"></span></p>
    <p th:text="'Search Timing: ' + ${searchTime} + ' ms'"></p>
    <p th:text="'Total ' + ${searchResultsCount} + ' results'"></p>
    <button id="exportButtonSearch" onclick="exportData('search')">Export Search Results</button>
</div>

<hr/>

<!-- Data table display -->
<table th:if="${data}" th:unless="${#lists.isEmpty(data)}">
    <thead>
    <tr>
        <th th:each="header : ${data[0].keySet()}" th:text="${header}"></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="row : ${data}">
        <td th:each="entry : ${row.entrySet()}" th:text="${entry.value}"></td>
    </tr>
    </tbody>
</table>

<!-- No data message -->
<p th:if="${#lists.isEmpty(data)}">No data, Please upload your file.</p>

</body>
</html>
