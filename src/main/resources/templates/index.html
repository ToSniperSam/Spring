<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>CSV 文件上传与排序</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .bold {
            font-weight: bold;
        }
        .info {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        .error {
            color: red;
        }
        .warning {
            color: orange;
        }
    </style>
    <script>
        // 排序数据
        function sortData() {
            const column = document.getElementById("sortColumn").value;
            const order = document.querySelector('input[name="order"]:checked').value;

            if (column) {
                const form = document.createElement("form");
                form.method = "post";
                form.action = "/sort";

                const columnInput = document.createElement("input");
                columnInput.type = "hidden";
                columnInput.name = "column";
                columnInput.value = column;

                const orderInput = document.createElement("input");
                orderInput.type = "hidden";
                orderInput.name = "order";
                orderInput.value = order;

                form.appendChild(columnInput);
                form.appendChild(orderInput);
                document.body.appendChild(form);
                form.submit();
            } else {
                alert("请选择排序列！");
            }
        }

        // 搜索数据
        function searchData() {
            const column = document.getElementById("searchColumn").value;
            const keyword = document.getElementById("searchKeyword").value;

            if (column && keyword) {
                const form = document.createElement("form");
                form.method = "post";
                form.action = "/search";

                const columnInput = document.createElement("input");
                columnInput.type = "hidden";
                columnInput.name = "column";
                columnInput.value = column;

                const keywordInput = document.createElement("input");
                keywordInput.type = "hidden";
                keywordInput.name = "keyword";
                keywordInput.value = keyword;

                form.appendChild(columnInput);
                form.appendChild(keywordInput);
                document.body.appendChild(form);
                form.submit();
            } else {
                alert("请选择搜索列和输入关键词！");
            }
        }

        // 导出数据
        function exportData(type) {
            // 根据类型设置请求的 URL，'search' 或 'sort'
            const url = `/export?type=${type}`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(error => {
                            throw new Error(error);
                        });
                    }
                    return response.blob();  // 获取返回的 CSV 文件
                })
                .then(blob => {
                    const downloadFileName = type === 'search' ? 'search_results.csv' : 'sorted_data.csv';

                    // 创建下载链接并触发下载
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = downloadFileName;  // 根据导出类型选择文件名
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => {
                    alert("导出失败：" + error.message);  // 错误提示
                });
        }

    </script>
</head>
<body>
<h1>CSV 文件上传与操作</h1>

<!-- 文件上传表单 -->
<form action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".csv" required />
    <button type="submit">上传文件</button>
</form>

<!-- 显示警告、错误、信息 -->
<div class="info" th:if="${message}" th:text="${message}"></div>
<div class="error" th:if="${error}" th:text="${error}"></div>
<div class="warning" th:if="${warning}" th:text="${warning}"></div>

<hr/>

<!-- 功能选择 -->
<h2>选择功能</h2>
<div>
    <button onclick="document.getElementById('sortSection').style.display = 'block'; document.getElementById('searchSection').style.display = 'none';">排序</button>
    <button onclick="document.getElementById('sortSection').style.display = 'none'; document.getElementById('searchSection').style.display = 'block';">搜索</button>
</div>

<hr/>

<!-- 排序表单 -->
<div id="sortSection" style="display:none;">
    <h2>排序设置</h2>
    <form method="post" onsubmit="sortData(); return false;">
        <label for="sortColumn">选择排序列:</label>
        <select id="sortColumn" name="column">
            <option value="VehicleType">VehicleType</option>
            <option value="DirectionTime_O">DirectionTime_O</option>
            <option value="GantryID_O">GantryID_O</option>
            <option value="TripLength">TripLength</option>
        </select>

        <label>
            <input type="radio" name="order" value="asc" checked /> 升序
        </label>
        <label>
            <input type="radio" name="order" value="desc" /> 降序
        </label>

        <button type="submit">排序</button>
    </form>
</div>

<!-- 搜索表单 -->
<div id="searchSection" style="display:none;">
    <h2>搜索设置</h2>
    <form method="post" onsubmit="searchData(); return false;">
        <label for="searchColumn">选择搜索列:</label>
        <select id="searchColumn" name="column">
            <option value="VehicleType">VehicleType</option>
            <option value="DirectionTime_O">DirectionTime_O</option>
            <option value="GantryID_O">GantryID_O</option>
            <option value="TripLength">TripLength</option>
        </select>

        <label for="searchKeyword">关键词:</label>
        <input type="text" id="searchKeyword" name="keyword" required />

        <button type="submit">搜索</button>
    </form>
</div>

<hr/>

<!-- 显示排序时间 -->
<div th:if="${sortTime}">
    <p>当前排序列：<span th:text="${currentColumn}"></span></p>

    <p th:text="'排序耗时: ' + ${sortTime} + ' 毫秒'"></p>
    <p th:text="'排序方式: ' + ${descending} "></p>
    <button id="exportButtonSort" onclick="exportData()">导出排序结果</button>
    <div id="exportError" style="color: red; display: none;"></div>
</div>

<!-- 显示搜索时间与结果条数 -->
<div th:if="${searchTime}">
    <p>关键词：<span th:text="${searchKeyword}"></span></p>
    <p th:text="'搜索耗时: ' + ${searchTime} + ' 毫秒'"></p>
    <p th:text="'共找到 ' + ${searchResultsCount} + ' 条相关数据'"></p>
    <button id="exportButtonSearch" onclick="exportData('search')">导出搜索结果</button>


</div>



<!-- 数据表格显示 -->
<table th:if="${data}" th:unless="${#lists.isEmpty(data)}">
    <thead>
    <tr>
        <th th:each="header : ${data[0].keySet()}" th:text="${header}"></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="row : ${data}">
        <td th:each="entry : ${row.entrySet()}" th:text="${entry.value}"></td>
    </tr>
    </tbody>
</table>

<!-- 没有数据时显示 -->
<p th:if="${#lists.isEmpty(data)}">暂无排序结果，请先上传文件并选择操作。</p>

</body>
</html>
